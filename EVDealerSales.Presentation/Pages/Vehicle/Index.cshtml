@page
@using EVDealerSales.BusinessObject.DTOs.VehicleDTOs
@using EVDealerSales.Business.Utils
@model EVDealerSales.Presentation.Pages.Vehicle.IndexModel
@{
    ViewData["Title"] = "Vehicle Management";
}

@section Styles {
    <link rel="stylesheet" href="~/css/staff-management.css" />
}

<div class="staff-page-clean">
    <div class="container">
        <!-- Header -->
        <div class="staff-header-clean">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div>
                    <h1 class="staff-title-clean">
                        <i class="bi bi-car-front"></i>
                        Vehicle Inventory
                    </h1>
                    <p class="staff-subtitle-clean">
                        Manage your electric vehicle inventory and specifications
                    </p>
                </div>
                <div>
                    <a asp-page="./Create" class="btn-clean btn-primary-clean">
                        <i class="bi bi-plus-circle"></i>
                        Add Vehicle
                    </a>
                </div>
            </div>
        </div>

        <!-- Alerts -->
        @if (TempData["SuccessMessage"] != null)
        {
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="bi bi-check-circle-fill"></i>
                @TempData["SuccessMessage"]
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }

        @if (TempData["ErrorMessage"] != null)
        {
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle-fill"></i>
                @TempData["ErrorMessage"]
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }

        <!-- Search and Filter Card -->
        <div class="staff-card-clean">
            <div class="staff-card-header-clean">
                <h3 class="staff-card-title-clean">
                    <i class="bi bi-funnel-fill"></i>
                    Search & Filters
                </h3>
            </div>
            <div class="staff-card-body-clean">
                <form method="get">
                    <!-- Search Bar -->
                    <div class="search-bar-clean">
                        <i class="bi bi-search search-icon-clean"></i>
                        <input type="text" class="search-input-clean" name="SearchTerm"
                               value="@Model.SearchTerm"
                               placeholder="Search by model or trim...">
                    </div>

                    <!-- Filter Grid -->
                    <div class="filter-grid-clean">
                        <div class="filter-group-clean">
                            <label class="filter-label-clean">
                                <i class="bi bi-sort-down"></i>
                                Sort By
                            </label>
                            <select name="SortBy" class="filter-input-clean">
                                <option value="">Default</option>
                                <option value="ModelName" selected="@(Model.SortBy == "ModelName")">Model Name</option>
                                <option value="ModelYear" selected="@(Model.SortBy == "ModelYear")">Model Year</option>
                                <option value="BasePrice" selected="@(Model.SortBy == "BasePrice")">Base Price</option>
                            </select>
                        </div>
                        <div class="filter-group-clean">
                            <label class="filter-label-clean">
                                <i class="bi bi-arrow-down-up"></i>
                                Order
                            </label>
                            <select name="SortDesc" class="filter-input-clean">
                                <option value="false" selected="@(!Model.SortDesc)">Ascending</option>
                                <option value="true" selected="@Model.SortDesc">Descending</option>
                            </select>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="filter-actions-clean">
                        <button type="submit" class="btn-clean btn-primary-clean">
                            <i class="bi bi-search"></i> Apply Filters
                        </button>
                        @if (!string.IsNullOrEmpty(Model.SearchTerm) || !string.IsNullOrEmpty(Model.SortBy))
                        {
                            <a asp-page-handler="ClearFilters" class="btn-clean btn-secondary-clean">
                                <i class="bi bi-x-circle"></i> Clear Filters
                            </a>
                        }
                    </div>
                </form>
            </div>
        </div>

        <!-- Vehicle List Card -->
        <div class="staff-card-clean">
            <div class="staff-card-header-clean">
                <h3 class="staff-card-title-clean">
                    <i class="bi bi-list-ul"></i>
                    Vehicles
                </h3>
                @if (Model.Vehicles.TotalCount > 0)
                {
                    <span style="color: #888; font-size: 0.875rem; font-weight: 500;">
                        @Model.Vehicles.TotalCount total
                    </span>
                }
            </div>
            <div class="staff-card-body-clean" style="padding: 0;">
                @if (Model.Vehicles.TotalCount == 0)
                {
                    <div class="empty-state-clean">
                        <div class="empty-icon-clean">
                            <i class="bi bi-car-front"></i>
                        </div>
                        <h3 class="empty-title-clean">No Vehicles Found</h3>
                        <p class="empty-description-clean">
                            @if (!string.IsNullOrEmpty(Model.SearchTerm))
                            {
                                <span>Try adjusting your search criteria</span>
                            }
                            else
                            {
                                <span>Get started by adding your first vehicle</span>
                            }
                        </p>
                        <a asp-page="./Create" class="btn-clean btn-primary-clean" style="margin-top: 1rem;">
                            <i class="bi bi-plus-circle"></i>
                            Add First Vehicle
                        </a>
                    </div>
                }
                else
                {
                    <div style="padding: 1.5rem;">
                        @foreach (var vehicle in Model.Vehicles)
                        {
                            <div style="background: #0a0a0a; border: 1px solid #1a1a1a; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; transition: all 0.2s ease;">
                                <div style="display: grid; grid-template-columns: auto 1fr 2fr 1fr auto; gap: 1.5rem; align-items: center;">
                                    <!-- Vehicle Image -->
                                    <div>
                                        <img src="@vehicle.ImageUrl" alt="@vehicle.ModelName"
                                             style="width: 80px; height: 80px; border-radius: 8px; object-fit: cover; border: 1px solid #1a1a1a;">
                                    </div>

                                    <!-- Vehicle Info -->
                                    <div>
                                        <div style="color: #fff; font-weight: 600; font-size: 0.95rem; margin-bottom: 0.25rem;">
                                            @vehicle.ModelName @vehicle.TrimName
                                        </div>
                                        <div style="color: #888; font-size: 0.8rem; margin-bottom: 0.5rem;">
                                            <i class="bi bi-calendar"></i> @vehicle.ModelYear
                                        </div>
                                        <div style="display: inline-block;">
                                            @if (vehicle.IsActive)
                                            {
                                                <span class="badge-clean badge-success" style="font-size: 0.7rem; padding: 0.25rem 0.5rem;">
                                                    <i class="bi bi-check-circle"></i> Active
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="badge-clean" style="background: rgba(108, 117, 125, 0.15); border-color: rgba(108, 117, 125, 0.4); color: #888; font-size: 0.7rem; padding: 0.25rem 0.5rem;">
                                                    <i class="bi bi-x-circle"></i> Inactive
                                                </span>
                                            }
                                        </div>
                                    </div>

                                    <!-- Specifications (Neutral colors except Stock) -->
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                                        <!-- Battery & Range (Neutral) -->
                                        <div style="padding: 0.5rem 0.75rem; background: rgba(255, 255, 255, 0.03); border-left: 3px solid #333; border-radius: 6px;">
                                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                                                <i class="bi bi-battery-charging" style="color: #888; font-size: 1rem;"></i>
                                                <div>
                                                    <div style="font-size: 0.7rem; color: #888; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; line-height: 1;">Battery</div>
                                                    <div style="color: #fff; font-weight: 600; font-size: 0.85rem;">@vehicle.BatteryCapacity kWh</div>
                                                </div>
                                            </div>
                                        </div>

                                        <div style="padding: 0.5rem 0.75rem; background: rgba(255, 255, 255, 0.03); border-left: 3px solid #333; border-radius: 6px;">
                                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                                                <i class="bi bi-signpost-2" style="color: #888; font-size: 1rem;"></i>
                                                <div>
                                                    <div style="font-size: 0.7rem; color: #888; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; line-height: 1;">Range</div>
                                                    <div style="color: #fff; font-weight: 600; font-size: 0.85rem;">@vehicle.RangeKM km</div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Top Speed (Neutral) & Stock (Colored based on level) -->
                                        <div style="padding: 0.5rem 0.75rem; background: rgba(255, 255, 255, 0.03); border-left: 3px solid #333; border-radius: 6px;">
                                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                                                <i class="bi bi-speedometer2" style="color: #888; font-size: 1rem;"></i>
                                                <div>
                                                    <div style="font-size: 0.7rem; color: #888; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; line-height: 1;">Top Speed</div>
                                                    <div style="color: #fff; font-weight: 600; font-size: 0.85rem;">@vehicle.TopSpeed km/h</div>
                                                </div>
                                            </div>
                                        </div>

                                        <div style="padding: 0.5rem 0.75rem; background: @(vehicle.Stock <= 0 ? "rgba(239, 68, 68, 0.08)" : vehicle.Stock <= 5 ? "rgba(245, 158, 11, 0.08)" : "rgba(34, 197, 94, 0.08)"); border-left: 3px solid @(vehicle.Stock <= 0 ? "#ef4444" : vehicle.Stock <= 5 ? "#f59e0b" : "#22c55e"); border-radius: 6px;">
                                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                                                <i class="bi bi-box-seam" style="color: @(vehicle.Stock <= 0 ? "#ef4444" : vehicle.Stock <= 5 ? "#f59e0b" : "#22c55e"); font-size: 1rem;"></i>
                                                <div>
                                                    <div style="font-size: 0.7rem; color: #888; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; line-height: 1;">Stock</div>
                                                    <div style="color: #fff; font-weight: 600; font-size: 0.85rem;">@vehicle.Stock units</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Price -->
                                    <div style="text-align: center;">
                                        <div style="font-size: 0.7rem; color: #888; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; margin-bottom: 0.25rem;">Base Price</div>
                                        <div style="color: #0070f3; font-weight: 700; font-size: 1.1rem;">
                                            $@vehicle.BasePrice.ToString("N0")
                                        </div>
                                    </div>

                                    <!-- Actions -->
                                    <div style="display: flex; gap: 0.5rem;">
                                        <a asp-page="./Details" asp-route-id="@vehicle.Id"
                                           class="btn-action-clean" title="View Details"
                                           style="font-size: 0.75rem; padding: 0.4rem 0.75rem;">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        <a asp-page="./Edit" asp-route-id="@vehicle.Id"
                                           class="btn-action-clean" title="Edit Vehicle"
                                           style="font-size: 0.75rem; padding: 0.4rem 0.75rem;">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        <button type="button" class="btn-action-clean btn-action-danger"
                                                onclick="showDeleteModal('@vehicle.Id', '@vehicle.ModelName @vehicle.TrimName')"
                                                title="Delete Vehicle"
                                                style="font-size: 0.75rem; padding: 0.4rem 0.75rem;">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>

                    <!-- Pagination -->
                    @if (Model.Vehicles.TotalPages > 1)
                    {
                        <div style="padding: 0 1.5rem 1.5rem 1.5rem;">
                            <div class="pagination-clean">
                                @if (Model.Vehicles.HasPrevious)
                                {
                                    <a class="page-btn-clean"
                                       asp-page="./Index"
                                       asp-route-PageNumber="@(Model.Vehicles.CurrentPage - 1)"
                                       asp-route-PageSize="@Model.Vehicles.PageSize"
                                       asp-route-SearchTerm="@Model.SearchTerm"
                                       asp-route-SortBy="@Model.SortBy"
                                       asp-route-SortDesc="@Model.SortDesc">
                                        <i class="bi bi-chevron-left"></i>
                                    </a>
                                }

                                @for (var i = Math.Max(1, Model.Vehicles.CurrentPage - 2); i <= Math.Min(Model.Vehicles.TotalPages, Model.Vehicles.CurrentPage + 2); i++)
                                {
                                    <a class="page-btn-clean @(i == Model.Vehicles.CurrentPage ? "active" : "")"
                                       asp-page="./Index"
                                       asp-route-PageNumber="@i"
                                       asp-route-PageSize="@Model.Vehicles.PageSize"
                                       asp-route-SearchTerm="@Model.SearchTerm"
                                       asp-route-SortBy="@Model.SortBy"
                                       asp-route-SortDesc="@Model.SortDesc">
                                        @i
                                    </a>
                                }

                                @if (Model.Vehicles.HasNext)
                                {
                                    <a class="page-btn-clean"
                                       asp-page="./Index"
                                       asp-route-PageNumber="@(Model.Vehicles.CurrentPage + 1)"
                                       asp-route-PageSize="@Model.Vehicles.PageSize"
                                       asp-route-SearchTerm="@Model.SearchTerm"
                                       asp-route-SortBy="@Model.SortBy"
                                       asp-route-SortDesc="@Model.SortDesc">
                                        <i class="bi bi-chevron-right"></i>
                                    </a>
                                }
                            </div>

                            <div class="pagination-info-clean">
                                Showing @((Model.Vehicles.CurrentPage - 1) * Model.Vehicles.PageSize + 1) to
                                @Math.Min(Model.Vehicles.CurrentPage * Model.Vehicles.PageSize, Model.Vehicles.TotalCount) of
                                @Model.Vehicles.TotalCount vehicles
                            </div>
                        </div>
                    }
                }
            </div>
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content modal-clean">
            <div class="modal-header-clean" style="background: rgba(239, 68, 68, 0.1); border-bottom-color: rgba(239, 68, 68, 0.3);">
                <h3 class="modal-title-clean" style="color: #ef4444;">
                    <i class="bi bi-exclamation-triangle"></i>
                    Confirm Delete
                </h3>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="deleteForm" method="post" asp-page-handler="Delete">
                @Html.AntiForgeryToken()
                <input type="hidden" name="id" id="deleteVehicleId" />
                <div class="modal-body-clean">
                    <div class="alert alert-warning" style="margin-bottom: 1rem;">
                        <i class="bi bi-exclamation-triangle"></i>
                        This action cannot be undone. The vehicle will be permanently removed from the system.
                    </div>
                    <p id="deleteMessage" style="margin: 0; color: #ccc; font-size: 0.9rem;"></p>
                </div>
                <div class="modal-footer-clean">
                    <button type="button" class="btn-clean btn-secondary-clean" data-bs-dismiss="modal">
                        Cancel
                    </button>
                    <button type="submit" class="btn-clean btn-danger-clean">
                        <i class="bi bi-trash"></i> Delete Vehicle
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function showDeleteModal(vehicleId, vehicleName) {
            const message = document.getElementById('deleteMessage');
            const hiddenId = document.getElementById('deleteVehicleId');

            hiddenId.value = vehicleId;
            message.innerHTML = `Are you sure you want to delete <strong style="color: #fff;">${vehicleName}</strong>?`;

            const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
            modal.show();
        }

        // Auto-hide alerts
        setTimeout(function () {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(alert => {
                alert.style.opacity = '0';
                setTimeout(() => alert.remove(), 300);
            });
        }, 5000);
    </script>
}
