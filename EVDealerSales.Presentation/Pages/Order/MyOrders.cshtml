@page
@using EVDealerSales.BusinessObject.DTOs.OrderDTOs
@using EVDealerSales.BusinessObject.Enums
@model EVDealerSales.Presentation.Pages.Order.MyOrdersModel
@{
    ViewData["Title"] = "My Orders";
}

@section Styles {
    <link rel="stylesheet" href="~/css/order.css" />
}

<div class="order-container">
    <div class="container-fluid">
        <div class="order-header">
            <h1 class="order-title">
                <i class="bi bi-bag-check-fill"></i>
                My Orders
            </h1>
        </div>

        @if (!string.IsNullOrEmpty(Model.SuccessMessage))
        {
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                @Model.SuccessMessage
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }

        @if (!string.IsNullOrEmpty(Model.ErrorMessage))
        {
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                @Model.ErrorMessage
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }

        @if (Model.Orders.TotalCount == 0)
        {
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="bi bi-cart-x"></i>
                </div>
                <h3 class="empty-title">No orders yet</h3>
                <a asp-page="/Vehicle/BrowseVehicles" class="btn btn-primary">
                    <i class="bi bi-search"></i>
                    Browse Vehicles
                </a>
            </div>
        }
        else
        {
            <div class="orders-list">
                @foreach (var order in Model.Orders)
                {
                    <div class="order-card">
                        <div class="order-card-header">
                            <div class="order-info">
                                <h3 class="order-number">#@order.OrderNumber</h3>
                                <span class="order-date">@order.CreatedAt.ToString("MMM dd, yyyy")</span>
                            </div>
                            <div class="order-status">
                                @switch (order.Status)
                                {
                                    case OrderStatus.Pending:
                                        <span class="badge badge-warning">Pending</span>
                                        break;
                                    case OrderStatus.Confirmed:
                                        <span class="badge badge-success">Confirmed</span>
                                        break;
                                    case OrderStatus.Cancelled:
                                        <span class="badge badge-danger">Cancelled</span>
                                        break;
                                }
                            </div>
                        </div>

                        <div class="order-card-body">
                            @foreach (var item in order.Items)
                            {
                                <div class="order-item">
                                    <div class="item-image">
                                        <img src="@(string.IsNullOrEmpty(item.VehicleImageUrl) ? "/placeholder.svg" : item.VehicleImageUrl)"
                                             alt="@item.VehicleModelName" />
                                    </div>
                                    <div class="item-details">
                                        <h4 class="item-name">@item.VehicleModelName @item.VehicleTrimName</h4>
                                        <p class="item-year">@item.Year</p>
                                    </div>
                                    <div class="item-price">
                                        <strong>$@item.UnitPrice.ToString("N0")</strong>
                                    </div>
                                </div>
                            }

                            <div class="order-summary">
                                <div class="summary-row">
                                    <span>Total:</span>
                                    <strong>$@order.TotalAmount.ToString("N0")</strong>
                                </div>

                                @if (order.PaymentStatus.HasValue)
                                {
                                    <div class="summary-row">
                                        <span>Payment:</span>
                                        <span class="@(order.PaymentStatus == PaymentStatus.Paid ? "text-success" : order.PaymentStatus == PaymentStatus.Failed ? "text-danger" : "text-warning")">
                                            @order.PaymentStatus.ToString()
                                        </span>
                                    </div>
                                }
                            </div>
                        </div>

                        <div class="order-card-footer">
                            <a asp-page="/Order/OrderDetail" asp-route-id="@order.Id" class="btn btn-sm btn-outline-primary">
                                View Details
                            </a>

                            @if (order.Status == OrderStatus.Pending && order.PaymentStatus != PaymentStatus.Paid)
                            {
                                <a asp-page="/Order/Checkout" asp-route-orderId="@order.Id" class="btn btn-sm btn-success">
                                    Pay Now
                                </a>
                                <button type="button" class="btn btn-sm btn-danger" onclick="cancelOrder('@order.Id', '@order.OrderNumber')">
                                    Cancel
                                </button>
                            }
                        </div>
                    </div>
                }
            </div>

            @if (Model.Orders.TotalPages > 1)
            {
                <div class="pagination-container">
                    <div class="pagination-info">
                        @((Model.Orders.CurrentPage - 1) * Model.Orders.PageSize + 1)-@Math.Min(Model.Orders.CurrentPage * Model.Orders.PageSize, Model.Orders.TotalCount) of @Model.Orders.TotalCount
                    </div>
                    <div class="pagination-controls">
                        @if (Model.Orders.HasPrevious)
                        {
                            <a class="page-btn" asp-page="./MyOrders" asp-route-PageNumber="@(Model.Orders.CurrentPage - 1)" asp-route-PageSize="@Model.Orders.PageSize">
                                <i class="bi bi-chevron-left"></i> Previous
                            </a>
                        }
                        @if (Model.Orders.HasNext)
                        {
                            <a class="page-btn" asp-page="./MyOrders" asp-route-PageNumber="@(Model.Orders.CurrentPage + 1)" asp-route-PageSize="@Model.Orders.PageSize">
                                Next <i class="bi bi-chevron-right"></i>
                            </a>
                        }
                    </div>
                </div>
            }
        }
    </div>
</div>

@section Scripts {
    <script>
        function cancelOrder(orderId, orderNumber) {
            if (confirm(`Cancel Order #${orderNumber}?`)) {
                const reason = prompt('Reason (optional):');

                if (reason === null) {
                    return;
                }
                fetch(`/Order/OrderDetail?id=${orderId}&handler=Cancel`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                    },
                    body: JSON.stringify({ reason: reason })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Order cancelled successfully');
                        window.location.reload();
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred');
                });
            }
        }
    </script>
}