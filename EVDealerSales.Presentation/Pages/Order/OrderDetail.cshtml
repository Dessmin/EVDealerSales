@page
@using EVDealerSales.BusinessObject.Enums
@model EVDealerSales.Presentation.Pages.Order.OrderDetailModel
@{
    ViewData["Title"] = "Order Details";

    // Determine if current user is staff
    var currentUser = User;
    var isStaff = currentUser.IsInRole("DealerStaff") || currentUser.IsInRole("DealerManager");

    string GetDeliveryStatusBadgeClass(DeliveryStatus status)
    {
        return status switch
        {
            DeliveryStatus.Pending => "badge bg-warning",
            DeliveryStatus.Scheduled => "badge bg-info",
            DeliveryStatus.InTransit => "badge bg-primary",
            DeliveryStatus.Delivered => "badge bg-success",
            DeliveryStatus.Cancelled => "badge bg-danger",
            _ => "badge bg-secondary"
        };
    }
}

@section Styles {
    <link rel="stylesheet" href="~/css/order.css" />
    <style>
        .delivery-timeline {
            position: relative;
            padding-left: 30px;
        }

        .timeline-item {
            position: relative;
            padding-bottom: 30px;
        }

            .timeline-item::before {
                content: '';
                position: absolute;
                left: -22px;
                top: 30px;
                width: 2px;
                height: calc(100% - 30px);
                background: #dee2e6;
            }

            .timeline-item:last-child::before {
                display: none;
            }

            .timeline-item.completed::before {
                background: #28a745;
            }

            .timeline-item.cancelled::before {
                background: #dc3545;
            }

        .timeline-marker {
            position: absolute;
            left: -30px;
            top: 0;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .timeline-item .timeline-marker i {
            font-size: 18px;
            color: #dee2e6;
        }

        .timeline-item.completed .timeline-marker i {
            color: #28a745;
        }

        .timeline-item.cancelled .timeline-marker i {
            color: #dc3545;
        }

        .timeline-content h6 {
            margin-bottom: 5px;
            font-weight: 600;
        }

        .timeline-content p {
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .order-summary-box {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

            .order-summary-box h6 {
                margin-bottom: 10px;
                font-weight: 600;
            }

            .order-summary-box > div {
                margin-bottom: 5px;
            }

        #feedbackModal .modal-header {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-bottom: 2px solid #2196f3;
        }

        #feedbackModal .modal-title {
            color: #1565c0;
            font-weight: 600;
        }

        #feedbackModal .modal-body {
            padding: 2rem;
        }

        #feedbackModal .alert-info {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
            color: #0d47a1;
            border-radius: 6px;
            padding: 1rem;
            display: flex;
            align-items: start;
            gap: 0.75rem;
        }

            #feedbackModal .alert-info i {
                color: #2196f3;
                font-size: 1.25rem;
                margin-top: 2px;
            }

        #feedbackModal .form-label {
            font-weight: 600;
            color: #1565c0;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

            #feedbackModal .form-label i {
                color: #42a5f5;
            }

        #feedbackModal .form-control {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 0.75rem;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }

            #feedbackModal .form-control:focus {
                border-color: #2196f3;
                box-shadow: 0 0 0 0.2rem rgba(33, 150, 243, 0.15);
                outline: none;
            }

        #feedbackModal .form-text {
            color: #757575;
            font-size: 0.85rem;
            margin-top: 0.25rem;
        }

        #feedbackModal .order-summary-box {
            background: linear-gradient(135deg, #f5f5f5 0%, #eeeeee 100%);
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 1.25rem;
            margin-top: 1.5rem;
        }

            #feedbackModal .order-summary-box h6 {
                color: #424242;
                font-size: 1rem;
                margin-bottom: 1rem;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

                #feedbackModal .order-summary-box h6 i {
                    color: #757575;
                }

            #feedbackModal .order-summary-box .d-flex {
                padding: 0.5rem 0;
                border-bottom: 1px solid #e0e0e0;
            }

                #feedbackModal .order-summary-box .d-flex:last-child {
                    border-bottom: none;
                }

            #feedbackModal .order-summary-box span {
                color: #757575;
                font-size: 0.9rem;
            }

            #feedbackModal .order-summary-box strong {
                color: #212121;
                font-weight: 600;
            }

        #feedbackModal .modal-footer {
            background-color: #fafafa;
            border-top: 2px solid #e0e0e0;
            padding: 1.25rem;
        }

            #feedbackModal .modal-footer .btn {
                padding: 0.625rem 1.5rem;
                font-weight: 500;
                border-radius: 6px;
                transition: all 0.3s ease;
            }

            #feedbackModal .modal-footer .btn-primary {
                background-color: #2196f3;
                border-color: #2196f3;
            }

                #feedbackModal .modal-footer .btn-primary:hover {
                    background-color: #1976d2;
                    border-color: #1976d2;
                    transform: translateY(-2px);
                    box-shadow: 0 4px 8px rgba(33, 150, 243, 0.3);
                }

            #feedbackModal .modal-footer .btn-secondary {
                background-color: #757575;
                border-color: #757575;
            }

                #feedbackModal .modal-footer .btn-secondary:hover {
                    background-color: #616161;
                    border-color: #616161;
                }

        /* ===== Request Delivery Modal Styles (không thay đổi) ===== */
        #requestDeliveryModal .modal-header {
            background: linear-gradient(135deg, #f1f8e9 0%, #dcedc8 100%);
            border-bottom: 2px solid #8bc34a;
        }

        #requestDeliveryModal .modal-title {
            color: #558b2f;
            font-weight: 600;
        }
    </style>
}

<div class="order-detail-container">
    <div class="container">
        <div class="order-detail-header">
            @if (isStaff)
            {
                <a asp-page="/Staff/ManageOrders" class="btn-back">
                    <i class="bi bi-arrow-left"></i> Back to Manage Orders
                </a>
            }
            else
            {
                <a asp-page="/Order/MyOrders" class="btn-back">
                    <i class="bi bi-arrow-left"></i> Back to My Orders
                </a>
            }
        </div>

        @if (!string.IsNullOrEmpty(Model.ErrorMessage))
        {
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle-fill"></i>
                @Model.ErrorMessage
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }

        @if (Model.Order != null)
        {
            <div class="order-detail-content">
                <!-- Order Information Card -->
                <div class="detail-card">
                    <div class="card-header">
                        <h2><i class="bi bi-receipt"></i> Order Information</h2>
                        <span class="@(Model.Order.Status == OrderStatus.Confirmed ? "badge badge-success" :
                                                                     Model.Order.Status == OrderStatus.Cancelled ? "badge badge-danger" :
                                                                     "badge badge-warning")">
                        @Model.Order.Status.ToString()
                    </span>
                </div>
                <div class="card-body">
                    <div class="info-grid">
                        <div class="info-item">
                            <label>Order Number:</label>
                            <span class="value-text">#@Model.Order.OrderNumber</span>
                        </div>
                        <div class="info-item">
                            <label>Order Date:</label>
                            <span class="value-text">@Model.Order.CreatedAt.ToString("MMM dd, yyyy hh:mm tt")</span>
                        </div>
                        <div class="info-item">
                            <label>Total Amount:</label>
                            <span class="value-text total-amount">$@Model.Order.TotalAmount.ToString("N0")</span>
                        </div>
                        @if (!string.IsNullOrEmpty(Model.Order.Notes))
                            {
                                <div class="info-item full-width">
                                    <label>Notes:</label>
                                    <span class="value-text">@Model.Order.Notes</span>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <!-- Vehicle Items -->
                <div class="detail-card">
                    <div class="card-header">
                        <h2><i class="bi bi-car-front-fill"></i> Order Items</h2>
                    </div>
                    <div class="card-body">
                        @foreach (var item in Model.Order.Items)
                        {
                            <div class="vehicle-item">
                                <div class="vehicle-image">
                                    <img src="@(string.IsNullOrEmpty(item.VehicleImageUrl) ? "/placeholder.svg" : item.VehicleImageUrl)"
                                         alt="@item.VehicleModelName" />
                                </div>
                                <div class="vehicle-info">
                                    <h3>@item.VehicleModelName @item.VehicleTrimName</h3>
                                    <p class="vehicle-year">@item.Year Model</p>
                                    <p class="vehicle-price">$@item.UnitPrice.ToString("N0")</p>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                @* Payment Pending Alert - Only show if order not paid and not cancelled *@
                @if (Model.Order.Status == OrderStatus.Confirmed && Model.Order.PaymentStatus != PaymentStatus.Paid && !isStaff)
                {
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i>
                        Payment pending. Please complete the payment to proceed with your order.
                    </div>
                    <a asp-page="/Order/Checkout" asp-route-orderId="@Model.Order.Id" class="btn btn-success btn-lg">
                        <i class="bi bi-credit-card"></i> Pay Now
                    </a>
                }

                <!-- Delivery Information -->
                @if (Model.Order.Delivery != null)
                {
                    <div class="detail-card">
                        <div class="card-header">
                            <h2><i class="bi bi-truck"></i> Delivery Tracking</h2>
                            <span class="@GetDeliveryStatusBadgeClass(Model.Order.Delivery.Status)">
                                @Model.Order.Delivery.Status.ToString()
                            </span>
                        </div>
                        <div class="card-body">
                            <!-- Delivery Timeline -->
                            <div class="delivery-timeline mb-4">
                                <div class="timeline-item @(Model.Order.Delivery.Status >= DeliveryStatus.Pending ? "completed" : "")">
                                    <div class="timeline-marker">
                                        <i class="bi bi-check-circle-fill"></i>
                                    </div>
                                    <div class="timeline-content">
                                        <h6>Request Submitted</h6>
                                        <p class="text-muted">@Model.Order.Delivery.CreatedAt.ToString("MMM dd, yyyy hh:mm tt")</p>
                                        @if (Model.Order.Delivery.Status == DeliveryStatus.Pending)
                                        {
                                            <span class="badge bg-warning">Waiting for staff confirmation</span>
                                        }
                                    </div>
                                </div>

                                <div class="timeline-item @(Model.Order.Delivery.Status >= DeliveryStatus.Scheduled ? "completed" : Model.Order.Delivery.Status == DeliveryStatus.Cancelled ? "cancelled" : "")">
                                    <div class="timeline-marker">
                                        <i class="bi @(Model.Order.Delivery.Status >= DeliveryStatus.Scheduled ? "bi-check-circle-fill" : Model.Order.Delivery.Status == DeliveryStatus.Cancelled ? "bi-x-circle-fill" : "bi-circle")"></i>
                                    </div>
                                    <div class="timeline-content">
                                        <h6>Confirmed & Scheduled</h6>
                                        @if (Model.Order.Delivery.PlannedDate.HasValue)
                                        {
                                            <p class="text-muted">Planned: @Model.Order.Delivery.PlannedDate.Value.ToString("MMM dd, yyyy")</p>
                                        }
                                        else if (Model.Order.Delivery.Status == DeliveryStatus.Pending)
                                        {
                                            <p class="text-muted">Pending confirmation</p>
                                        }
                                    </div>
                                </div>

                                <div class="timeline-item @(Model.Order.Delivery.Status >= DeliveryStatus.InTransit ? "completed" : Model.Order.Delivery.Status == DeliveryStatus.Cancelled ? "cancelled" : "")">
                                    <div class="timeline-marker">
                                        <i class="bi @(Model.Order.Delivery.Status >= DeliveryStatus.InTransit ? "bi-check-circle-fill" : Model.Order.Delivery.Status == DeliveryStatus.Cancelled ? "bi-x-circle-fill" : "bi-circle")"></i>
                                    </div>
                                    <div class="timeline-content">
                                        <h6>In Transit</h6>
                                        @if (Model.Order.Delivery.Status == DeliveryStatus.InTransit)
                                        {
                                            <p class="text-primary"><i class="bi bi-truck"></i> Your order is on the way!</p>
                                        }
                                        else if (Model.Order.Delivery.Status < DeliveryStatus.InTransit && Model.Order.Delivery.Status != DeliveryStatus.Cancelled)
                                        {
                                            <p class="text-muted">Not yet started</p>
                                        }
                                    </div>
                                </div>

                                <div class="timeline-item @(Model.Order.Delivery.Status == DeliveryStatus.Delivered ? "completed" : Model.Order.Delivery.Status == DeliveryStatus.Cancelled ? "cancelled" : "")">
                                    <div class="timeline-marker">
                                        <i class="bi @(Model.Order.Delivery.Status == DeliveryStatus.Delivered ? "bi-check-circle-fill" : Model.Order.Delivery.Status == DeliveryStatus.Cancelled ? "bi-x-circle-fill" : "bi-circle")"></i>
                                    </div>
                                    <div class="timeline-content">
                                        <h6>@(Model.Order.Delivery.Status == DeliveryStatus.Cancelled ? "Cancelled" : "Delivered")</h6>
                                        @if (Model.Order.Delivery.ActualDate.HasValue)
                                        {
                                            <p class="text-success"><i class="bi bi-check-circle"></i> Delivered on @Model.Order.Delivery.ActualDate.Value.ToString("MMM dd, yyyy")</p>
                                        }
                                        else if (Model.Order.Delivery.Status == DeliveryStatus.Cancelled)
                                        {
                                            <p class="text-danger"><i class="bi bi-x-circle"></i> Delivery cancelled</p>
                                        }
                                        else
                                        {
                                            <p class="text-muted">Awaiting delivery</p>
                                        }
                                    </div>
                                </div>
                            </div>

                            <!-- Delivery Details -->
                            <div class="info-grid">
                                @if (!string.IsNullOrEmpty(Model.Order.Delivery.ShippingAddress))
                                {
                                    <div class="info-item full-width">
                                        <label><i class="bi bi-pin-map-fill"></i> Delivery Address:</label>
                                        <span class="value-text">@Model.Order.Delivery.ShippingAddress</span>
                                    </div>
                                }
                                @if (!string.IsNullOrEmpty(Model.Order.Delivery.Notes))
                                {
                                    <div class="info-item full-width">
                                        <label><i class="bi bi-chat-left-text"></i> Your Notes:</label>
                                        <span class="value-text">@Model.Order.Delivery.Notes</span>
                                    </div>
                                }
                                @if (!string.IsNullOrEmpty(Model.Order.Delivery.StaffNotes))
                                {
                                    <div class="info-item full-width">
                                        <label><i class="bi bi-person-badge"></i> Staff Notes:</label>
                                        <span class="value-text">@Model.Order.Delivery.StaffNotes</span>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }

                <!-- Action Buttons -->
                <div class="action-buttons">
                    @if (Model.Order.Status == OrderStatus.Pending && Model.Order.PaymentStatus != PaymentStatus.Paid && !isStaff)
                    {
                        <a asp-page="/Order/Checkout" asp-route-orderId="@Model.Order.Id" class="btn btn-success">
                            <i class="bi bi-credit-card"></i> Pay Now
                        </a>
                        <button type="button" class="btn btn-danger" onclick="cancelOrder('@Model.Order.Id', '@Model.Order.OrderNumber')">
                            <i class="bi bi-x-circle"></i> Cancel Order
                        </button>
                    }

                    @* Request Delivery Button - Show if paid and no delivery yet (only for customers) *@
                    @if (Model.Order.PaymentStatus == PaymentStatus.Paid && Model.Order.Delivery == null && !isStaff)
                    {
                        var hoursSinceConfirmation = Model.Order.UpdatedAt.HasValue 
                            ? (DateTime.UtcNow - Model.Order.UpdatedAt.Value).TotalHours 
                            : 0;
                        var canRequestDelivery = hoursSinceConfirmation <= 24;
                        var hoursRemaining = canRequestDelivery ? (24 - hoursSinceConfirmation) : 0;
                        
                        if (canRequestDelivery)
                        {
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#requestDeliveryModal">
                                <i class="bi bi-truck"></i> Request Delivery
                            </button>
                            <div class="alert alert-info mt-2 mb-0">
                                <i class="bi bi-clock"></i> 
                                You have <strong>@hoursRemaining.ToString("F1") hours</strong> remaining to request delivery
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle"></i> 
                                The 24-hour window to request delivery has expired. Please contact support for assistance.
                            </div>
                        }
                    }

                    @* Cancel Delivery Button - Show if delivery status is Pending (only for customers) *@
                    @if (Model.Order.Delivery != null && Model.Order.Delivery.Status == DeliveryStatus.Pending && !isStaff)
                    {
                        <button type="button" class="btn btn-warning" onclick="cancelDelivery('@Model.Order.Delivery.Id')">
                            <i class="bi bi-x-circle"></i> Cancel Delivery Request
                        </button>
                    }
                    @* Feedback Button - Show if order is confirmed (only for customers) *@
                    @if (Model.Order.Status == OrderStatus.Confirmed && !isStaff)
                    {
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#feedbackModal">
                            <i class="bi bi-chat-left-text"></i> Give Feedback
                        </button>
                    }
                </div>
            </div>
        }
    </div>
</div>

@* Request Delivery Modal *@
<div class="modal fade" id="requestDeliveryModal" tabindex="-1" aria-labelledby="requestDeliveryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="requestDeliveryModalLabel">
                    <i class="bi bi-truck"></i> Request Delivery
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="requestDeliveryForm">
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        Please provide your delivery address. Our staff will review and confirm your delivery request.
                    </div>

                    <div class="mb-3">
                        <label for="shippingAddress" class="form-label">
                            <i class="bi bi-pin-map-fill"></i> Shipping Address <span class="text-danger">*</span>
                        </label>
                        <textarea id="shippingAddress"
                                  name="shippingAddress"
                                  class="form-control"
                                  rows="3"
                                  required
                                  placeholder="Enter your complete delivery address (Street, City, State, ZIP)"></textarea>
                        <div class="form-text">
                            Please provide a complete and accurate address for delivery
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="deliveryNotes" class="form-label">
                            <i class="bi bi-chat-left-text"></i> Additional Notes (Optional)
                        </label>
                        <textarea id="deliveryNotes"
                                  name="notes"
                                  class="form-control"
                                  rows="3"
                                  placeholder="Any special instructions for delivery (e.g., gate code, preferred delivery time)"></textarea>
                    </div>

                    <div class="order-summary-box">
                        <h6><i class="bi bi-box-seam"></i> Order Summary</h6>
                        <div class="d-flex justify-content-between">
                            <span>Order Number:</span>
                            <strong>@Model.Order.OrderNumber</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Vehicle:</span>
                            <strong>@string.Join(", ", Model.Order.Items.Select(i => $"{i.VehicleModelName} {i.VehicleTrimName}"))</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Total Amount:</span>
                            <strong class="text-success">$@Model.Order.TotalAmount.ToString("N0")</strong>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Cancel
                    </button>
                    <button type="submit" class="btn btn-primary" id="submitDeliveryRequest">
                        <i class="bi bi-send"></i> Submit Request
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
@* Feedback Modal - Thêm sau Request Delivery Modal *@
<div class="modal fade" id="feedbackModal" tabindex="-1" aria-labelledby="feedbackModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="feedbackModalLabel">
                    <i class="bi bi-chat-left-text"></i> Give Feedback
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="feedbackForm">
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        Your feedback helps us improve our service. Please share your experience with your order, vehicle, and our service.
                    </div>

                    <div class="mb-3">
                        <label for="feedbackContent" class="form-label">
                            <i class="bi bi-chat-left-dots"></i> Your Feedback <span class="text-danger">*</span>
                        </label>
                        <textarea id="feedbackContent"
                                  name="content"
                                  class="form-control"
                                  rows="5"
                                  required
                                  placeholder="Tell us about your experience with the vehicle, our service, and overall satisfaction..."></textarea>
                        <div class="form-text">
                            Minimum 10 characters required
                        </div>
                    </div>

                    <div class="order-summary-box">
                        <h6><i class="bi bi-box-seam"></i> Order Information</h6>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Order Number:</span>
                            <strong>@Model.Order.OrderNumber</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Vehicle:</span>
                            <strong>@string.Join(", ", Model.Order.Items.Select(i => $"{i.VehicleModelName} {i.VehicleTrimName}"))</strong>
                        </div>
                        @if (Model.Order.Delivery?.ActualDate.HasValue == true)
                        {
                            <div class="d-flex justify-content-between">
                                <span>Delivered On:</span>
                                <strong>@Model.Order.Delivery.ActualDate.Value.ToString("MMM dd, yyyy")</strong>
                            </div>
                        }
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Cancel
                    </button>
                    <button type="submit" class="btn btn-primary" id="submitFeedback">
                        <i class="bi bi-send"></i> Submit Feedback
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Request Delivery Form Submit
        document.getElementById('requestDeliveryForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();

            const submitBtn = document.getElementById('submitDeliveryRequest');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Submitting...';

            const formData = {
                orderId: '@Model.Order.Id',
                shippingAddress: document.getElementById('shippingAddress').value,
                notes: document.getElementById('deliveryNotes').value
            };

            try {
                const response = await fetch('/Order/OrderDetail?handler=RequestDelivery', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (data.success) {
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('requestDeliveryModal'));
                    modal.hide();

                    // Show success message
                    alert('Delivery request submitted successfully! Our staff will review and confirm your request.');

                    // Reload page to show delivery info
                    window.location.reload();
                } else {
                    alert('Error: ' + (data.message || 'Failed to submit delivery request'));
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while submitting your request. Please try again.');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        });

        // Feedback Form Submit - THÊM ĐOẠN NÀY VÀO ĐÂY
        document.getElementById('feedbackForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();

            const content = document.getElementById('feedbackContent').value.trim();

            // Validate minimum length
            if (content.length < 10) {
                alert('Feedback must be at least 10 characters long');
                return;
            }

            const submitBtn = document.getElementById('submitFeedback');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Submitting...';

            const formData = {
                orderId: '@Model.Order.Id',
                content: content
            };

            try {
                const response = await fetch('/Order/OrderDetail?handler=SubmitFeedback', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (data.success) {
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('feedbackModal'));
                    modal.hide();

                    // Show success message
                    alert('Thank you for your feedback! We appreciate your input.');

                    // Reset form
                    document.getElementById('feedbackContent').value = '';

                    // Reload page
                    window.location.reload();
                } else {
                    alert('Error: ' + (data.message || 'Failed to submit feedback'));
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while submitting your feedback. Please try again.');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        });

        // Cancel Delivery Function
        async function cancelDelivery(deliveryId) {
            if (!confirm('Are you sure you want to cancel your delivery request?')) {
                return;
            }

            try {
                const response = await fetch('/Order/OrderDetail?handler=CancelDelivery', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                    },
                    body: JSON.stringify({ deliveryId: deliveryId })
                });

                const data = await response.json();

                if (data.success) {
                    alert('Delivery request cancelled successfully');
                    window.location.reload();
                } else {
                    alert('Error: ' + (data.message || 'Failed to cancel delivery request'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            }
        }

        function cancelOrder(orderId, orderNumber) {
            if (confirm(`Are you sure you want to cancel Order #${orderNumber}?`)) {
                const reason = prompt('Please provide a reason for cancellation (optional):');

                if(reason === null) {
                    return;
                }
                fetch(`/Order/OrderDetail?id=${orderId}&handler=Cancel`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                    },
                    body: JSON.stringify({ reason: reason })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Order cancelled successfully');
                        window.location.href = '/Order/MyOrders';
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while cancelling the order');
                });
            }
        }
    </script>
}